# Notification service
Сервис уведомлений построенный на Django 4.2, Django REST Framework 3.14.0, Celery 5.2.7, PostgreSQL 15.2, RabbitMQ 3.11.15, Erlang 25.3.2, Python 3.9.

## Задача
Необходимо разработать сервис управления рассылками API администрирования и получения статистики.

## Описание
• Необходимо реализовать методы создания новой рассылки, просмотра созданных и получения статистики по выполненным рассылкам.

• Реализовать сам сервис отправки уведомлений на внешнее API.

• Опционально вы можете выбрать любое количество дополнительных пунктов описанных после основного.

• Документация по API для интеграции с разработанным сервисом.

• Описание реализованных методов в формате OpenAPI.


## Основное задание
Спроектировать и разработать сервис, который по заданным правилам запускает рассылку по списку клиентов.

Сущность "рассылка" имеет атрибуты:

• уникальный id рассылки

• дата и время запуска рассылки

• текст сообщения для доставки клиенту

• фильтр свойств клиентов, на которых должна быть произведена рассылка (код мобильного оператора, тег)

• дата и время окончания рассылки: если по каким-то причинам не успели разослать все сообщения - никакие сообщения клиентам после этого времени доставляться не должны

Сущность "клиент" имеет атрибуты:

• уникальный id клиента

• номер телефона клиента в формате 7XXXXXXXXXX (X - цифра от 0 до 9)

• код мобильного оператора

• тег (произвольная метка)

• часовой пояс

Сущность "сообщение" имеет атрибуты:

• уникальный id сообщения

• дата и время создания (отправки)

• статус отправки

• id рассылки, в рамках которой было отправлено сообщение

• id клиента, которому отправили

Спроектировать и реализовать API для:

• добавления нового клиента в справочник со всеми его атрибутами

• обновления данных атрибутов клиента

• удаления клиента из справочника

• добавления новой рассылки со всеми её атрибутами

• получения общей статистики по созданным рассылкам и количеству отправленных сообщений по ним с группировкой по статусам

• получения детальной статистики отправленных сообщений по конкретной рассылке

• обновления атрибутов рассылки

• удаления рассылки

• обработки активных рассылок и отправки сообщений клиентам

## Логика рассылки
• После создания новой рассылки, если текущее время больше времени начала и меньше времени окончания - должны быть выбраны из справочника все клиенты, которые подходят под значения фильтра, указанного в этой рассылке и запущена отправка для всех этих клиентов.

• Если создаётся рассылка с временем старта в будущем - отправка должна стартовать автоматически по наступлению этого времени без дополнительных действий со стороны пользователя системы.

• По ходу отправки сообщений должна собираться статистика (см. описание сущности "сообщение" выше) по каждому сообщению для последующего формирования отчётов.

• Внешний сервис, который принимает отправляемые сообщения, может долго обрабатывать запрос, отвечать некорректными данными, на какое-то время вообще не принимать запросы. Необходимо реализовать корректную обработку подобных ошибок. Проблемы с внешним сервисом не должны влиять на стабильность работы разрабатываемого сервиса рассылок.

## API внешнего сервиса отправки
Для интеграции с разрабатываемым проектом в данном задании существует внешний сервис, который может принимать запросы на отправку сообщений в сторону клиентов.

OpenAPI спецификация находится по адресу: [https://probe.fbrq.cloud/docs](https://probe.fbrq.cloud/docs)

В этом API предполагается аутентификация с использованием JWT. 

## Дополнительные задания
1. организовать тестирование написанного кода

2. сделать так, чтобы по адресу /docs/ открывалась страница со Swagger UI и в нём отображалось описание разработанного API. Пример: [https://petstore.swagger.io](https://petstore.swagger.io/)

3. удаленный сервис может быть недоступен, долго отвечать на запросы или выдавать некорректные ответы. Необходимо организовать обработку ошибок и откладывание запросов при неуспехе для последующей повторной отправки. Задержки в работе внешнего сервиса никак не должны оказывать влияние на работу сервиса рассылок.

4. обеспечить подробное логирование на всех этапах обработки запросов, чтобы при эксплуатации была возможность найти в логах всю информацию по:

• id рассылки - все логи по конкретной рассылке (и запросы на api и внешние запросы на отправку конкретных сообщений)

• id сообщения - по конкретному сообщению (все запросы и ответы от внешнего сервиса, вся обработка конкретного сообщения)

• id клиента - любые операции, которые связаны с конкретным клиентом (добавление/редактирование/отправка сообщения/…)

## Инструкция запуска:

### Тестировалось под Windows 10.

1) Устанавливаем PostgreSQL 15

2) Заходим в SQL Shell (psql), после того как зашли создаём нового пользователя и две базы данных:

```
    CREATE USER ns_usr WITH PASSWORD 'D8$j%_d12KlOsCa93F#';
    CREATE DATABASE ns_db WITH OWNER ns_usr;
    CREATE DATABASE test_ns_db WITH OWNER ns_usr;
    \q
```


3) Устанавливаем OTP и RabbitMQ:

https://github.com/erlang/otp/releases/download/OTP-25.3.2/otp_win64_25.3.2.exe

https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.11.15/rabbitmq-server-3.11.15.exe

4) Открываем RabbitMQ Command Prompt, и вводим следующие команды:

```
    cd C:\Program Files\RabbitMQ Server\rabbitmq_server-3.11.15\sbin
    
    rabbitmq-plugins.bat enable rabbitmq_management
    rabbitmq-service.bat stop
    rabbitmq-service.bat install
    rabbitmq-service.bat start
```


Открывайте RabbitMQ Management по адресу http://localhost:15672/ логин: guest, пароль: guest.

Далее по переходу во вкладку Admin заполняете:

```
    Username: SBroker
    Password: f*jS38Sv_7J4k
```


Жмёте Add user
Затем жмёте по имени SBroker в списке вверху и задав параметры:

```
    Virtual Host: /
    C.regexp: .*
    W.regexp: .*
    R.regexp: .*
```


жмёте Set permission.

Альтернативный вариант создания пользователя и задания ему привилегий через RabbitMQ Command Prompt:

```
    rabbitmqctl add_user SBroker f*jS38Sv_7J4k
    rabbitmqctl set_user_tags SBroker administrator
    rabbitmqctl set_permissions -p / SBroker ".*" ".*" ".*"
    rabbitmqctl list_users
```


5) Скачиваем репозиторий (весь код)

6) В терминале в папке с кодом выполняем команду:

```
    pip install -r requirements.txt
```


7) Затем команды:

```
    python manage.py migrate
    python manage.py migrate --database=test
```


8) Затем запускаем сервер:

```
    python manage.py runserver
```


9) В отдельном терминале запускаем Celery:

```
    celery -A notification_service worker -l info --pool=solo
```


10) В ещё одном отдельном терминале можно запустить тесты:

```
    python manage.py test
```


11) После того как пройдут тесты, можно проверить как работает API:

По адресу http://127.0.0.1:8000/api/ мы видим корень API, с понятным описанием и кликабельными примерами, собственно здесь и так всё понятно.

Но в проекте так же есть автоматически сгенерированный **openapi-schema.yml** файл документации OpenAPI (на основе него работает /docs/), и подправленный, с некоторым описанием openapi.yaml, который удобно просмотреть через https://editor.swagger.io/ или прямо здесь по ссылке: https://gitlab.com/mytestsprojects/notification_service/-/blob/main/openapi.yaml

12) По адресу http://127.0.0.1:8000/docs/ присутствует Swagger подобное OpenAPI руководство (основано на автоматической генерации "из коробки", поэтому не идеальное, в файле **openapi.yaml** всё же несколько лучше).

13) В файле **logfile.log** можно увидеть подробные логи с id всех важных сущностей на каждом этапе.

14) Уже используемый нами **requirements.txt** содержит все зависимости.
